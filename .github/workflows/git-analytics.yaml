name: Git Analytics

on:
  push:
    branches: [ main, develop ]
  schedule:
    - cron: '0 0 * * 1'  # Weekly on Monday at 00:00 UTC

jobs:
  git-analytics:
    runs-on: ubuntu-latest
    env:
      GITHUB_PAT: ${{ secrets.GITHUB_TOKEN }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Fetch full history for analytics

      - uses: r-lib/actions/setup-r@v2
        with:
          use-public-rspm: true

      - uses: r-lib/actions/setup-r-dependencies@v2
        with:
          cache-version: 1
          packages: |
            any::gert
            any::dplyr
            any::readr

      - name: Run git analytics
        run: |
          # Source the git analytics functions
          source("inst/git-analytics.R")
          
          # Generate development report
          report <- generate_dev_report(".")
          
          # Print summary
          cat("Repository Analytics Summary:\n")
          cat("Total commits:", report$git_stats$total_commits, "\n")
          cat("Unique authors:", report$git_stats$unique_authors, "\n")
          cat("First commit:", report$git_stats$first_commit, "\n")
          cat("Latest commit:", report$git_stats$latest_commit, "\n")
          
          # Save report as JSON
          jsonlite::write_json(report, "git-analytics-report.json")
        shell: Rscript {0}

      - name: Upload analytics report
        uses: actions/upload-artifact@v4
        with:
          name: git-analytics-report
          path: git-analytics-report.json