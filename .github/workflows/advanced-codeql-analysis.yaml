name: Advanced CodeQL Security Analysis

on:
  push:
    branches: [main, master]
  pull_request:
    branches: [main, master]
  schedule:
    - cron: '0 4 * * *'

jobs:
  codeql-analysis:
    runs-on: ubuntu-latest

    permissions:
      actions: read
      contents: read
      security-events: write

    steps:
      - uses: actions/checkout@v4

      - name: Initialize CodeQL
        uses: github/codeql-action/init@v3
        with:
          languages: javascript, r
          config-file: ./.github/codeql-config.yml

      - name: Setup R
        uses: r-lib/actions/setup-r@v2
        with:
          r-version: 'release'

      - name: Setup R dependencies
        uses: r-lib/actions/setup-r-dependencies@v2

      - name: Run R security checks
        run: |
          Rscript -e "
            # Check for common security issues in R code
            library(tools)

            # Scan for potentially dangerous functions
            r_files <- list.files('R/', pattern = '\\\\.R$', full.names = TRUE)
            dangerous_patterns <- c(
              'system\\\\(',
              'shell\\\\(',
              'eval\\\\(',
              'parse\\\\(',
              'source\\\\(',
              'readRDS\\\\(',
              'load\\\\('
            )

            for (file in r_files) {
              content <- readLines(file, warn = FALSE)
              for (pattern in dangerous_patterns) {
                matches <- grep(pattern, content, value = TRUE)
                if (length(matches) > 0) {
                  cat('⚠️  Potential security concern in', file, '\n')
                  for (match in matches) {
                    cat('   ', match, '\n')
                  }
                }
              }
            }
          "

      - name: Perform CodeQL Analysis
        uses: github/codeql-action/analyze@v3
        with:
          category: "/language:javascript"
          upload: false

      - name: Perform CodeQL Analysis (R)
        uses: github/codeql-action/analyze@v3
        with:
          category: "/language:r"
          upload: false

      - name: Upload SARIF results
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        with:
          sarif_file: results.sarif
