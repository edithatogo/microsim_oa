# Tutorial 3: Longitudinal Disease Progression Modeling
# ================================================

This tutorial demonstrates longitudinal disease progression modeling using time-series health data. It covers tracking disease progression over time, survival analysis, and predictive modeling for health outcomes.

## Learning Objectives

By the end of this tutorial, you will be able to:

1. Analyze longitudinal health data patterns
2. Build survival models for disease progression
3. Create time-series models for health outcomes
4. Perform longitudinal data visualization
5. Interpret progression trajectories
6. Apply predictive modeling for health forecasting

## Prerequisites

- Completion of Tutorials 1 and 2
- Understanding of time-series concepts
- Basic knowledge of survival analysis
- Familiarity with longitudinal data structures

## Dataset Description

This tutorial uses synthetic longitudinal health data including:

- **5,000 patients** with 5-year follow-up data
- **Time-series measurements**: Disease progression markers, symptoms, treatments
- **Clinical outcomes**: Disease severity, functional status, quality of life
- **Longitudinal covariates**: Age, comorbidities, treatment adherence
- **Event data**: Disease progression events, treatment changes, hospitalizations

## Longitudinal Analysis Concepts

### Key Methods

1. **Survival Analysis**: Time-to-event modeling for disease progression
2. **Mixed Effects Models**: Accounting for correlation within subjects
3. **Time-Series Analysis**: Trend analysis and forecasting
4. **Trajectory Modeling**: Identifying distinct progression patterns
5. **Longitudinal Visualization**: Effective display of temporal patterns

### Clinical Applications

- Disease progression monitoring
- Treatment effectiveness evaluation
- Risk stratification and prediction
- Clinical trial design and analysis
- Health policy evaluation

---

## Exercise 1: Loading and Exploring Longitudinal Data

### 1.1 Load Longitudinal Health Data

Load the synthetic longitudinal health dataset and examine its structure.

```r
# Load required packages
library(tidyverse)
library(survival)
library(lme4)
library(ggplot2)
library(scales)
library(aus_oa_public)
set.seed(12345)

# Load longitudinal health data
longitudinal_data <- readRDS("data/longitudinal_health_data.rds")

# Alternative: Load from CSV
# longitudinal_data <- read_csv("data/longitudinal_health_data.csv")
```

### 1.2 Examine Longitudinal Data Structure

Explore the structure and characteristics of longitudinal data.

```r
# View dataset dimensions and structure
dim(longitudinal_data)
str(longitudinal_data)
summary(longitudinal_data)

# Check number of observations per patient
patient_counts <- longitudinal_data %>%
  group_by(patient_id) %>%
  summarise(n_visits = n()) %>%
  count(n_visits)

print("Observations per patient:")
print(patient_counts)

# Check time span
time_span <- longitudinal_data %>%
  group_by(patient_id) %>%
  summarise(
    first_visit = min(visit_date),
    last_visit = max(visit_date),
    total_span = as.numeric(last_visit - first_visit) / 365.25
  )

cat("\nTime span summary (years):\n")
summary(time_span$total_span)
```

### 1.3 Data Quality Assessment

Assess the quality and completeness of longitudinal data.

```r
# Check for missing values over time
missing_patterns <- longitudinal_data %>%
  group_by(visit_number) %>%
  summarise(
    total_obs = n(),
    missing_pain = sum(is.na(pain_score)),
    missing_function = sum(is.na(functional_score)),
    missing_qol = sum(is.na(qol_score))
  ) %>%
  mutate(
    pct_missing_pain = missing_pain / total_obs * 100,
    pct_missing_function = missing_function / total_obs * 100,
    pct_missing_qol = missing_qol / total_obs * 100
  )

print("Missing data patterns by visit:")
print(missing_patterns)

# Check for irregular visit intervals
visit_intervals <- longitudinal_data %>%
  arrange(patient_id, visit_date) %>%
  group_by(patient_id) %>%
  mutate(
    prev_visit = lag(visit_date),
    interval_days = as.numeric(visit_date - prev_visit)
  ) %>%
  filter(!is.na(interval_days))

cat("\nVisit interval summary (days):\n")
summary(visit_intervals$interval_days)
```

---

## Exercise 2: Basic Longitudinal Patterns

### 2.1 Disease Progression Trajectories

Analyze basic patterns of disease progression over time.

```r
# Overall disease progression trends
progression_trends <- longitudinal_data %>%
  group_by(visit_number) %>%
  summarise(
    mean_pain = mean(pain_score, na.rm = TRUE),
    mean_function = mean(functional_score, na.rm = TRUE),
    mean_qol = mean(qol_score, na.rm = TRUE),
    mean_disease_severity = mean(disease_severity, na.rm = TRUE),
    n = n()
  )

print("Disease progression trends by visit:")
print(progression_trends)

# Individual patient trajectories (sample)
sample_patients <- sample(unique(longitudinal_data$patient_id), 10)

sample_trajectories <- longitudinal_data %>%
  filter(patient_id %in% sample_patients) %>%
  select(patient_id, visit_number, pain_score, functional_score, qol_score)

print("Sample patient trajectories:")
head(sample_trajectories, 20)
```

### 2.2 Treatment Response Patterns

Analyze how treatments affect disease progression over time.

```r
# Treatment response analysis
treatment_response <- longitudinal_data %>%
  group_by(treatment_status, visit_number) %>%
  summarise(
    mean_pain = mean(pain_score, na.rm = TRUE),
    mean_function = mean(functional_score, na.rm = TRUE),
    mean_qol = mean(qol_score, na.rm = TRUE),
    n = n()
  )

print("Treatment response patterns:")
print(treatment_response)

# Treatment switching patterns
treatment_changes <- longitudinal_data %>%
  arrange(patient_id, visit_date) %>%
  group_by(patient_id) %>%
  mutate(
    prev_treatment = lag(treatment_status),
    treatment_change = treatment_status != prev_treatment & !is.na(prev_treatment)
  ) %>%
  summarise(
    total_changes = sum(treatment_change, na.rm = TRUE),
    first_treatment = first(treatment_status),
    final_treatment = last(treatment_status)
  )

cat("\nTreatment switching summary:\n")
summary(treatment_changes$total_changes)
```

### 2.3 Comorbidity Impact on Progression

Examine how comorbidities influence disease progression trajectories.

```r
# Comorbidity impact analysis
comorbidity_impact <- longitudinal_data %>%
  group_by(comorbidity_count, visit_number) %>%
  summarise(
    mean_pain = mean(pain_score, na.rm = TRUE),
    mean_function = mean(functional_score, na.rm = TRUE),
    mean_qol = mean(qol_score, na.rm = TRUE),
    n = n()
  )

print("Comorbidity impact on progression:")
print(comorbidity_impact)

# Comorbidity progression correlation
comorbidity_correlations <- longitudinal_data %>%
  group_by(patient_id) %>%
  summarise(
    baseline_comorbidities = first(comorbidity_count),
    final_comorbidities = last(comorbidity_count),
    comorbidity_change = final_comorbidities - baseline_comorbidities,
    pain_change = last(pain_score) - first(pain_score),
    function_change = last(functional_score) - first(functional_score)
  )

print("Comorbidity correlations with disease progression:")
cor(comorbidity_correlations[, c("comorbidity_change", "pain_change", "function_change")],
    use = "complete.obs")
```

---

## Exercise 3: Survival Analysis

### 3.1 Time-to-Progression Analysis

Perform survival analysis for disease progression events.

```r
# Prepare survival data
survival_data <- longitudinal_data %>%
  group_by(patient_id) %>%
  summarise(
    progression_time = min(visit_number[disease_progression == 1], na.rm = TRUE),
    progressed = any(disease_progression == 1),
    baseline_age = first(age),
    baseline_severity = first(disease_severity),
    baseline_comorbidities = first(comorbidity_count),
    treatment_started = any(treatment_status == "Active")
  ) %>%
  mutate(
    progression_time = ifelse(is.infinite(progression_time), max(longitudinal_data$visit_number), progression_time)
  )

print("Survival data summary:")
summary(survival_data)

# Kaplan-Meier survival curve
km_fit <- survfit(Surv(progression_time, progressed) ~ 1, data = survival_data)
print("Kaplan-Meier estimate:")
print(km_fit)
```

### 3.2 Cox Proportional Hazards Model

Build a Cox model to identify risk factors for disease progression.

```r
# Cox proportional hazards model
cox_model <- coxph(
  Surv(progression_time, progressed) ~
    baseline_age + baseline_severity + baseline_comorbidities + treatment_started,
  data = survival_data
)

print("Cox proportional hazards model:")
summary(cox_model)

# Calculate hazard ratios
hazard_ratios <- exp(coef(cox_model))
print("Hazard ratios:")
print(hazard_ratios)

# Model diagnostics
cox_zph <- cox.zph(cox_model)
print("Proportional hazards test:")
print(cox_zph)
```

### 3.3 Stratified Survival Analysis

Analyze survival patterns by different patient subgroups.

```r
# Stratified analysis by age groups
survival_data <- survival_data %>%
  mutate(
    age_group = cut(baseline_age,
                   breaks = c(18, 50, 70, Inf),
                   labels = c("Young", "Middle", "Older"))
  )

# Kaplan-Meier by age group
km_by_age <- survfit(Surv(progression_time, progressed) ~ age_group, data = survival_data)
print("Survival by age group:")
print(km_by_age)

# Cox model with interactions
cox_interaction <- coxph(
  Surv(progression_time, progressed) ~
    baseline_age * treatment_started + baseline_severity + baseline_comorbidities,
  data = survival_data
)

print("Cox model with interaction:")
summary(cox_interaction)
```

---

## Exercise 4: Mixed Effects Models

### 4.1 Linear Mixed Effects for Pain Scores

Build mixed effects models to account for correlation within subjects.

```r
# Prepare data for mixed effects modeling
mixed_data <- longitudinal_data %>%
  select(patient_id, visit_number, pain_score, functional_score, qol_score,
         age, comorbidity_count, treatment_status) %>%
  na.omit()

# Linear mixed effects model for pain
pain_lme <- lmer(
  pain_score ~ visit_number + age + comorbidity_count + treatment_status +
               (1 + visit_number | patient_id),
  data = mixed_data
)

print("Linear mixed effects model for pain:")
summary(pain_lme)

# Random effects
print("Random effects:")
ranef(pain_lme)
```

### 4.2 Functional Status Mixed Model

Analyze functional status trajectories using mixed effects.

```r
# Mixed effects model for functional status
function_lme <- lmer(
  functional_score ~ visit_number + age + comorbidity_count + treatment_status +
                    (1 + visit_number | patient_id),
  data = mixed_data
)

print("Mixed effects model for functional status:")
summary(function_lme)

# Compare fixed vs random effects
print("Fixed effects comparison:")
fixef(pain_lme)
fixef(function_lme)
```

### 4.3 Quality of Life Trajectory Modeling

Model quality of life changes over time.

```r
# Mixed effects model for quality of life
qol_lme <- lmer(
  qol_score ~ visit_number + age + comorbidity_count + treatment_status +
             (1 + visit_number | patient_id),
  data = mixed_data
)

print("Mixed effects model for quality of life:")
summary(qol_lme)

# Model comparison
cat("\nModel comparison (AIC):\n")
cat("Pain model AIC:", AIC(pain_lme), "\n")
cat("Function model AIC:", AIC(function_lme), "\n")
cat("QoL model AIC:", AIC(qol_lme), "\n")
```

---

## Exercise 5: Time-Series Analysis

### 5.1 Disease Severity Time Series

Analyze disease severity as a time series.

```r
# Aggregate disease severity by time
severity_ts <- longitudinal_data %>%
  group_by(visit_number) %>%
  summarise(
    mean_severity = mean(disease_severity, na.rm = TRUE),
    sd_severity = sd(disease_severity, na.rm = TRUE),
    n = n()
  )

print("Disease severity time series:")
print(severity_ts)

# Time series decomposition
severity_ts_data <- ts(severity_ts$mean_severity, frequency = 4)  # Quarterly data
severity_decomp <- decompose(severity_ts_data)

print("Time series decomposition:")
print(severity_decomp$trend)
```

### 5.2 Autoregressive Models

Build autoregressive models for prediction.

```r
# Simple ARIMA model for disease severity
library(forecast)

# Fit ARIMA model
severity_arima <- auto.arima(severity_ts$mean_severity)
print("ARIMA model for disease severity:")
summary(severity_arima)

# Forecast future values
severity_forecast <- forecast(severity_arima, h = 4)
print("Severity forecast:")
print(severity_forecast)

# Model diagnostics
checkresiduals(severity_arima)
```

### 5.3 Seasonal Patterns Analysis

Analyze seasonal patterns in health outcomes.

```r
# Add seasonal component
longitudinal_data <- longitudinal_data %>%
  mutate(
    month = month(visit_date),
    season = case_when(
      month %in% c(12, 1, 2) ~ "Summer",
      month %in% c(3, 4, 5) ~ "Autumn",
      month %in% c(6, 7, 8) ~ "Winter",
      month %in% c(9, 10, 11) ~ "Spring"
    )
  )

# Seasonal analysis
seasonal_analysis <- longitudinal_data %>%
  group_by(season, visit_number) %>%
  summarise(
    mean_pain = mean(pain_score, na.rm = TRUE),
    mean_function = mean(functional_score, na.rm = TRUE),
    n = n()
  )

print("Seasonal patterns in health outcomes:")
print(seasonal_analysis)
```

---

## Exercise 6: Trajectory Analysis

### 6.1 Patient Trajectory Clustering

Identify distinct progression patterns using clustering.

```r
# Prepare trajectory data
trajectory_data <- longitudinal_data %>%
  select(patient_id, visit_number, pain_score, functional_score, qol_score) %>%
  na.omit() %>%
  pivot_wider(
    names_from = visit_number,
    values_from = c(pain_score, functional_score, qol_score),
    names_prefix = "visit_"
  )

# K-means clustering on pain trajectories
pain_trajectory_cols <- grep("^pain_score_visit_", names(trajectory_data), value = TRUE)
pain_trajectories <- trajectory_data[, pain_trajectory_cols] %>%
  na.omit()

# Determine optimal number of clusters
wss <- sapply(1:6, function(k) {
  kmeans(pain_trajectories, centers = k, nstart = 10)$tot.withinss
})

# Perform clustering
set.seed(12345)
pain_clusters <- kmeans(pain_trajectories, centers = 3, nstart = 10)

trajectory_data$pain_trajectory_group <- pain_clusters$cluster

print("Trajectory cluster centers:")
print(pain_clusters$centers)
```

### 6.2 Trajectory Group Characteristics

Analyze characteristics of different trajectory groups.

```r
# Trajectory group analysis
trajectory_characteristics <- longitudinal_data %>%
  left_join(trajectory_data[, c("patient_id", "pain_trajectory_group")], by = "patient_id") %>%
  filter(!is.na(pain_trajectory_group)) %>%
  group_by(pain_trajectory_group) %>%
  summarise(
    n_patients = n_distinct(patient_id),
    mean_age = mean(age, na.rm = TRUE),
    pct_female = mean(sex == "Female", na.rm = TRUE) * 100,
    mean_comorbidities = mean(comorbidity_count, na.rm = TRUE),
    pct_treated = mean(treatment_status == "Active", na.rm = TRUE) * 100,
    mean_baseline_pain = mean(pain_score[visit_number == 1], na.rm = TRUE),
    mean_final_pain = mean(pain_score[visit_number == max(visit_number)], na.rm = TRUE)
  )

print("Trajectory group characteristics:")
print(trajectory_characteristics)
```

### 6.3 Trajectory Visualization

Create visualizations of different progression trajectories.

```r
# Trajectory visualization data
trajectory_viz <- longitudinal_data %>%
  left_join(trajectory_data[, c("patient_id", "pain_trajectory_group")], by = "patient_id") %>%
  filter(!is.na(pain_trajectory_group))

# Plot trajectories by group
trajectory_plot <- ggplot(trajectory_viz,
                         aes(x = visit_number, y = pain_score,
                             group = patient_id, color = factor(pain_trajectory_group))) +
  geom_line(alpha = 0.3) +
  stat_smooth(aes(group = pain_trajectory_group), method = "loess", size = 1.5) +
  labs(
    title = "Pain Score Trajectories by Group",
    x = "Visit Number",
    y = "Pain Score",
    color = "Trajectory Group"
  ) +
  theme_minimal()

print(trajectory_plot)
```

---

## Exercise 7: Predictive Modeling

### 7.1 Disease Progression Prediction

Build predictive models for disease progression.

```r
# Prepare prediction data
prediction_data <- longitudinal_data %>%
  group_by(patient_id) %>%
  mutate(
    future_progression = lead(disease_progression, 2),  # Predict 2 visits ahead
    future_pain = lead(pain_score, 2),
    future_function = lead(functional_score, 2)
  ) %>%
  filter(!is.na(future_progression)) %>%
  select(patient_id, visit_number, pain_score, functional_score, qol_score,
         disease_severity, comorbidity_count, treatment_status,
         future_progression, future_pain, future_function)

# Logistic regression for progression prediction
progression_model <- glm(
  future_progression ~ pain_score + functional_score + qol_score +
                      disease_severity + comorbidity_count + treatment_status,
  data = prediction_data,
  family = binomial
)

print("Disease progression prediction model:")
summary(progression_model)

# Model evaluation
progression_pred <- predict(progression_model, type = "response")
progression_pred_class <- ifelse(progression_pred > 0.5, 1, 0)

progression_confusion <- table(
  Actual = prediction_data$future_progression,
  Predicted = progression_pred_class
)

print("Progression prediction confusion matrix:")
print(progression_confusion)
```

### 7.2 Pain Score Forecasting

Build models to forecast future pain scores.

```r
# Linear regression for pain prediction
pain_prediction_model <- lm(
  future_pain ~ pain_score + functional_score + qol_score +
               disease_severity + comorbidity_count + treatment_status,
  data = prediction_data
)

print("Pain score prediction model:")
summary(pain_prediction_model)

# Model performance
pain_pred <- predict(pain_prediction_model)
pain_rmse <- sqrt(mean((prediction_data$future_pain - pain_pred)^2, na.rm = TRUE))
pain_mae <- mean(abs(prediction_data$future_pain - pain_pred), na.rm = TRUE)

cat("\nPain prediction performance:\n")
cat("RMSE:", round(pain_rmse, 3), "\n")
cat("MAE:", round(pain_mae, 3), "\n")
```

### 7.3 Risk Stratification

Develop risk stratification models for clinical decision making.

```r
# Risk stratification using predicted probabilities
risk_data <- prediction_data %>%
  mutate(
    progression_risk = progression_pred,
    risk_category = case_when(
      progression_risk < 0.2 ~ "Low",
      progression_risk < 0.5 ~ "Medium",
      TRUE ~ "High"
    )
  )

# Risk category analysis
risk_analysis <- risk_data %>%
  group_by(risk_category) %>%
  summarise(
    n_patients = n_distinct(patient_id),
    mean_actual_progression = mean(future_progression),
    mean_predicted_risk = mean(progression_risk),
    mean_current_pain = mean(pain_score, na.rm = TRUE),
    pct_treated = mean(treatment_status == "Active") * 100
  )

print("Risk stratification analysis:")
print(risk_analysis)
```

---

## Exercise 8: Advanced Longitudinal Visualizations

### 8.1 Spaghetti Plots

Create spaghetti plots for individual trajectories.

```r
# Spaghetti plot for pain trajectories
spaghetti_plot <- ggplot(longitudinal_data %>% sample_n(100),
                        aes(x = visit_number, y = pain_score, group = patient_id)) +
  geom_line(alpha = 0.3, color = "steelblue") +
  stat_smooth(method = "loess", color = "red", size = 1.5, se = FALSE) +
  labs(
    title = "Individual Pain Trajectories (Sample)",
    x = "Visit Number",
    y = "Pain Score"
  ) +
  theme_minimal()

print(spaghetti_plot)
```

### 8.2 Longitudinal Profile Plots

Create profile plots showing multiple outcomes over time.

```r
# Longitudinal profile plot
profile_data <- longitudinal_data %>%
  group_by(visit_number) %>%
  summarise(
    mean_pain = mean(pain_score, na.rm = TRUE),
    mean_function = mean(functional_score, na.rm = TRUE),
    mean_qol = mean(qol_score, na.rm = TRUE),
    se_pain = sd(pain_score, na.rm = TRUE) / sqrt(n()),
    se_function = sd(functional_score, na.rm = TRUE) / sqrt(n()),
    se_qol = sd(qol_score, na.rm = TRUE) / sqrt(n())
  )

profile_plot <- ggplot(profile_data, aes(x = visit_number)) +
  geom_line(aes(y = mean_pain, color = "Pain"), size = 1) +
  geom_line(aes(y = mean_function, color = "Function"), size = 1) +
  geom_line(aes(y = mean_qol, color = "QoL"), size = 1) +
  geom_ribbon(aes(ymin = mean_pain - se_pain, ymax = mean_pain + se_pain),
              alpha = 0.2, fill = "red") +
  geom_ribbon(aes(ymin = mean_function - se_function, ymax = mean_function + se_function),
              alpha = 0.2, fill = "blue") +
  geom_ribbon(aes(ymin = mean_qol - se_qol, ymax = mean_qol + se_qol),
              alpha = 0.2, fill = "green") +
  labs(
    title = "Longitudinal Health Outcomes Profile",
    x = "Visit Number",
    y = "Score",
    color = "Outcome"
  ) +
  theme_minimal()

print(profile_plot)
```

### 8.3 Survival Curves Visualization

Create visualizations of survival analysis results.

```r
# Survival curves plot
library(survminer)

survival_plot <- ggsurvplot(
  km_by_age,
  data = survival_data,
  risk.table = TRUE,
  conf.int = TRUE,
  palette = "jco",
  title = "Disease Progression Survival by Age Group",
  xlab = "Time (visits)",
  ylab = "Survival Probability"
)

print(survival_plot)
```

---

## Key Takeaways

1. **Longitudinal Patterns**: Disease progression shows distinct trajectories that can be modeled and predicted
2. **Survival Analysis**: Time-to-event methods provide valuable insights into disease progression timing
3. **Mixed Effects Models**: Account for correlation within subjects and provide robust estimates
4. **Time-Series Methods**: Enable forecasting and trend analysis for health outcomes
5. **Trajectory Analysis**: Identifies distinct progression patterns for personalized medicine
6. **Predictive Modeling**: Supports risk stratification and clinical decision making

## Next Steps

- **Tutorial 4**: Geographic health disparities analysis
- **Advanced Topics**: Machine learning for trajectory prediction, advanced survival methods
- **Clinical Applications**: Treatment optimization, clinical trial design

## Additional Resources

- [Survival Analysis in R](https://www.emilyzabor.com/tutorials/survival_analysis_in_r_tutorial.html)
- [Longitudinal Data Analysis](https://www.coursera.org/learn/longitudinal-data-analysis)
- [Mixed Effects Models](https://cran.r-project.org/web/packages/lme4/vignettes/lmer.pdf)

---

*This tutorial is part of the AUS-OA educational series demonstrating longitudinal disease progression modeling techniques.*</content>
<parameter name="filePath">\\wsl.localhost\Ubuntu\home\doughnut\github\aus_oa_public\tutorials\tutorial_03_longitudinal_modeling\tutorial_exercises.Rmd
