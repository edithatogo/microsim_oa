# Tutorial 1: Basic Population Health Modeling
# ===============================================

This tutorial demonstrates basic population health modeling concepts using synthetic Australian health survey data. It covers data exploration, statistical analysis, and simple modeling techniques.

## Learning Objectives

By the end of this tutorial, you will be able to:

1. Load and explore health survey datasets
2. Calculate osteoarthritis prevalence rates
3. Analyze risk factors for osteoarthritis
4. Build and evaluate statistical models
5. Create effective data visualizations
6. Interpret model results for health policy

## Prerequisites

- Basic R programming knowledge
- Familiarity with tidyverse packages
- Understanding of basic statistical concepts

## Dataset Description

The tutorial uses synthetic health survey data mimicking the Australian Institute of Health and Welfare (AIHW) National Health Survey. The dataset includes:

- **50,000 synthetic patient records**
- **Demographic information**: age, sex, state
- **Health metrics**: BMI, osteoarthritis status, pain scores
- **Lifestyle factors**: physical activity, smoking status
- **Healthcare utilization**: GP visits, specialist visits, costs

## Tutorial Structure

1. **Data Loading and Exploration**
2. **Prevalence Analysis**
3. **Risk Factor Analysis**
4. **Statistical Modeling**
5. **Data Visualization**
6. **Advanced Analysis**
7. **Results Export**

---

## Exercise 1: Data Loading and Basic Exploration

### 1.1 Load the Health Survey Data

Load the synthetic health survey data and examine its structure.

```r
# Load the health survey data
health_data <- readRDS("data/health_survey_data.rds")

# Alternative: Load from CSV
# health_data <- read_csv("data/health_survey_data.csv")
```

### 1.2 Examine Dataset Structure

Use R functions to understand the dataset structure and content.

```r
# View dataset structure
str(health_data)

# Summary statistics
summary(health_data)

# Check dimensions
dim(health_data)
```

### 1.3 Check for Missing Values

Identify any missing data in the dataset.

```r
# Count missing values per column
colSums(is.na(health_data))

# Percentage of missing values
colMeans(is.na(health_data)) * 100
```

### 1.4 View Sample Data

Look at the first few rows to understand the data format.

```r
# First 10 rows
head(health_data, 10)

# Random sample of 5 rows
sample_n(health_data, 5)
```

---

## Exercise 2: Osteoarthritis Prevalence Analysis

### 2.1 Calculate Overall OA Prevalence

Calculate the overall prevalence of osteoarthritis in the population.

```r
# Overall prevalence
overall_prevalence <- health_data %>%
  summarise(
    total_patients = n(),
    oa_cases = sum(osteoarthritis),
    prevalence_pct = (oa_cases / total_patients) * 100
  )

print(overall_prevalence)
```

### 2.2 Prevalence by Age Groups

Analyze how prevalence varies across different age groups.

```r
# Create age groups and calculate prevalence
age_prevalence <- health_data %>%
  mutate(
    age_group = cut(age,
                   breaks = c(18, 35, 50, 65, 80, Inf),
                   labels = c("18-34", "35-49", "50-64", "65-79", "80+"))
  ) %>%
  group_by(age_group) %>%
  summarise(
    total = n(),
    oa_cases = sum(osteoarthritis),
    prevalence = (oa_cases / total) * 100
  ) %>%
  arrange(age_group)

print(age_prevalence)
```

### 2.3 Prevalence by Sex and State

Examine prevalence differences by sex and geographic location.

```r
# Prevalence by sex and state
sex_state_prevalence <- health_data %>%
  group_by(sex, state) %>%
  summarise(
    total = n(),
    oa_cases = sum(osteoarthritis),
    prevalence = (oa_cases / total) * 100,
    .groups = "drop"
  ) %>%
  arrange(state, sex)

print(sex_state_prevalence)
```

---

## Exercise 3: Risk Factor Analysis

### 3.1 BMI Categories and OA Risk

Analyze the relationship between BMI categories and osteoarthritis.

```r
# BMI categories analysis
bmi_analysis <- health_data %>%
  mutate(
    bmi_category = cut(bmi,
                      breaks = c(-Inf, 18.5, 25, 30, Inf),
                      labels = c("Underweight", "Normal", "Overweight", "Obese"))
  ) %>%
  group_by(bmi_category) %>%
  summarise(
    total = n(),
    oa_cases = sum(osteoarthritis),
    prevalence = (oa_cases / total) * 100
  )

print(bmi_analysis)
```

### 3.2 Comorbidities Analysis

Examine how the number of comorbidities affects OA prevalence.

```r
# Comorbidities analysis
comorbidities_analysis <- health_data %>%
  mutate(
    comorbidity_group = cut(comorbidities,
                           breaks = c(-Inf, 0, 2, 5, Inf),
                           labels = c("None", "1-2", "3-5", "6+"))
  ) %>%
  group_by(comorbidity_group) %>%
  summarise(
    total = n(),
    oa_cases = sum(osteoarthritis),
    prevalence = (oa_cases / total) * 100
  )

print(comorbidities_analysis)
```

### 3.3 Physical Activity and OA

Investigate the relationship between physical activity levels and OA.

```r
# Physical activity analysis
activity_analysis <- health_data %>%
  group_by(physical_activity) %>%
  summarise(
    total = n(),
    oa_cases = sum(osteoarthritis),
    prevalence = (oa_cases / total) * 100
  )

print(activity_analysis)
```

---

## Exercise 4: Statistical Modeling

### 4.1 Prepare Data for Modeling

Prepare the dataset for statistical modeling by creating necessary variables.

```r
# Prepare modeling dataset
model_data <- health_data %>%
  mutate(
    high_bmi = bmi >= 30,
    older_age = age >= 65,
    female = sex == "Female"
  ) %>%
  select(osteoarthritis, age, high_bmi, female, comorbidities) %>%
  na.omit()

# Check the prepared data
str(model_data)
summary(model_data)
```

### 4.2 Build Logistic Regression Model

Create a logistic regression model to predict osteoarthritis risk.

```r
# Fit logistic regression model
oa_model <- glm(osteoarthritis ~ age + high_bmi + female + comorbidities,
                data = model_data,
                family = binomial)

# View model summary
summary(oa_model)
```

### 4.3 Calculate Odds Ratios

Calculate and interpret odds ratios from the model.

```r
# Calculate odds ratios
odds_ratios <- exp(coef(oa_model))
print(odds_ratios)

# Create a nice table of odds ratios
odds_table <- data.frame(
  Variable = names(odds_ratios),
  Odds_Ratio = round(odds_ratios, 3)
)
print(odds_table)
```

### 4.4 Model Evaluation

Evaluate the model's predictive performance.

```r
# Generate predictions
model_predictions <- predict(oa_model, type = "response")
predicted_classes <- ifelse(model_predictions > 0.5, 1, 0)

# Create confusion matrix
confusion_matrix <- table(Actual = model_data$osteoarthritis,
                         Predicted = predicted_classes)
print(confusion_matrix)

# Calculate accuracy
accuracy <- sum(diag(confusion_matrix)) / sum(confusion_matrix)
cat("Model Accuracy:", round(accuracy * 100, 2), "%\n")

# Calculate precision and recall
precision <- confusion_matrix[2,2] / sum(confusion_matrix[,2])
recall <- confusion_matrix[2,2] / sum(confusion_matrix[2,])
cat("Precision:", round(precision * 100, 2), "%\n")
cat("Recall:", round(recall * 100, 2), "%\n")
```

### 4.5 ROC Curve Analysis

Create and interpret ROC curve for model evaluation.

```r
# Load pROC package for ROC analysis
library(pROC)

# Create ROC curve
roc_curve <- roc(model_data$osteoarthritis, model_predictions)

# Calculate AUC
auc_value <- auc(roc_curve)
cat("AUC:", round(auc_value, 3), "\n")

# Plot ROC curve
plot(roc_curve, main = "ROC Curve for OA Prediction Model")
```

---

## Exercise 5: Data Visualization

### 5.1 Age Distribution by OA Status

Create a histogram showing age distribution by osteoarthritis status.

```r
# Age distribution plot
age_plot <- ggplot(health_data, aes(x = age, fill = factor(osteoarthritis))) +
  geom_histogram(alpha = 0.7, bins = 30, position = "identity") +
  labs(
    title = "Age Distribution by Osteoarthritis Status",
    x = "Age",
    y = "Count",
    fill = "OA Status"
  ) +
  scale_fill_brewer(palette = "Set2", labels = c("No OA", "Has OA")) +
  theme_minimal()

print(age_plot)
```

### 5.2 BMI Distribution

Create a histogram of BMI values with reference lines for categories.

```r
# BMI distribution plot
bmi_plot <- ggplot(health_data, aes(x = bmi)) +
  geom_histogram(bins = 30, fill = "steelblue", alpha = 0.7) +
  geom_vline(xintercept = 25, linetype = "dashed", color = "orange") +
  geom_vline(xintercept = 30, linetype = "dashed", color = "red") +
  labs(
    title = "BMI Distribution",
    x = "BMI",
    y = "Count"
  ) +
  annotate("text", x = 22, y = 1500, label = "Normal", color = "orange") +
  annotate("text", x = 27.5, y = 1500, label = "Overweight", color = "orange") +
  annotate("text", x = 32, y = 1500, label = "Obese", color = "red") +
  theme_minimal()

print(bmi_plot)
```

### 5.3 Pain Scores by OA Status

Create a boxplot comparing pain scores between OA and non-OA patients.

```r
# Pain scores boxplot
pain_plot <- ggplot(health_data, aes(x = factor(osteoarthritis), y = pain_score,
                                    fill = factor(osteoarthritis))) +
  geom_boxplot(alpha = 0.7) +
  labs(
    title = "Pain Scores by Osteoarthritis Status",
    x = "Osteoarthritis Status",
    y = "Pain Score (0-10)",
    fill = "OA Status"
  ) +
  scale_x_discrete(labels = c("No OA", "Has OA")) +
  scale_fill_brewer(palette = "Set2") +
  theme_minimal()

print(pain_plot)
```

### 5.4 Prevalence by State

Create a bar chart showing OA prevalence by Australian state.

```r
# State prevalence plot
state_plot <- health_data %>%
  group_by(state) %>%
  summarise(
    prevalence = mean(osteoarthritis) * 100,
    count = n()
  ) %>%
  ggplot(aes(x = reorder(state, prevalence), y = prevalence)) +
  geom_bar(stat = "identity", fill = "steelblue", alpha = 0.7) +
  geom_text(aes(label = sprintf("%.1f%%", prevalence)), hjust = -0.1) +
  coord_flip() +
  labs(
    title = "Osteoarthritis Prevalence by State",
    x = "State",
    y = "Prevalence (%)"
  ) +
  scale_y_continuous(limits = c(0, max(prevalence) * 1.2)) +
  theme_minimal()

print(state_plot)
```

### 5.5 Correlation Heatmap

Create a correlation heatmap of key variables.

```r
# Select numeric variables for correlation
correlation_data <- health_data %>%
  select(age, bmi, pain_score, comorbidities, osteoarthritis) %>%
  mutate(osteoarthritis = as.numeric(osteoarthritis))

# Calculate correlation matrix
correlation_matrix <- cor(correlation_data, use = "complete.obs")

# Create correlation plot
library(corrplot)
corrplot(correlation_matrix,
         method = "color",
         type = "upper",
         addCoef.col = "black",
         tl.col = "black",
         tl.srt = 45,
         title = "Correlation Matrix of Health Variables")
```

---

## Exercise 6: Advanced Analysis

### 6.1 Multiple Regression with Interactions

Build a more complex model including interactions and additional variables.

```r
# Advanced model with interactions
advanced_model <- glm(osteoarthritis ~ age * female + bmi + comorbidities +
                                     physical_activity + smoking_status,
                      data = health_data,
                      family = binomial)

# View model summary
summary(advanced_model)

# Compare models
cat("Simple model AIC:", AIC(oa_model), "\n")
cat("Advanced model AIC:", AIC(advanced_model), "\n")
```

### 6.2 Predicted Probabilities

Create predictions across different age and sex combinations.

```r
# Create prediction data
prediction_data <- expand.grid(
  age = seq(18, 85, by = 5),
  female = c(TRUE, FALSE),
  bmi = mean(health_data$bmi, na.rm = TRUE),
  comorbidities = mean(health_data$comorbidities, na.rm = TRUE),
  physical_activity = "Moderate",
  smoking_status = "Never"
)

# Generate predictions
prediction_data$predicted_prob <- predict(advanced_model,
                                        newdata = prediction_data,
                                        type = "response")

# Plot predictions
prediction_plot <- ggplot(prediction_data,
                         aes(x = age, y = predicted_prob * 100,
                             color = factor(female, labels = c("Male", "Female")))) +
  geom_line(size = 1) +
  labs(
    title = "Predicted OA Probability by Age and Sex",
    x = "Age",
    y = "Predicted Probability (%)",
    color = "Sex"
  ) +
  theme_minimal()

print(prediction_plot)
```

### 6.3 Healthcare Cost Analysis

Analyze healthcare costs by osteoarthritis status.

```r
# Healthcare cost analysis
cost_analysis <- health_data %>%
  group_by(osteoarthritis) %>%
  summarise(
    mean_cost = mean(healthcare_cost),
    median_cost = median(healthcare_cost),
    sd_cost = sd(healthcare_cost),
    n = n()
  )

print(cost_analysis)

# Visualize cost differences
cost_plot <- ggplot(health_data, aes(x = factor(osteoarthritis),
                                    y = healthcare_cost,
                                    fill = factor(osteoarthritis))) +
  geom_boxplot(alpha = 0.7) +
  scale_y_log10() +
  labs(
    title = "Healthcare Costs by Osteoarthritis Status",
    x = "Osteoarthritis Status",
    y = "Healthcare Cost (log scale)",
    fill = "OA Status"
  ) +
  scale_x_discrete(labels = c("No OA", "Has OA")) +
  scale_fill_brewer(palette = "Set2") +
  theme_minimal()

print(cost_plot)
```

### 6.4 Quality of Life Analysis

Examine quality of life measures by osteoarthritis status.

```r
# Quality of life analysis
qol_analysis <- health_data %>%
  group_by(osteoarthritis) %>%
  summarise(
    mean_eq5d = mean(eq5d_score),
    mean_physical = mean(physical_functioning),
    n = n()
  )

print(qol_analysis)

# Visualize EQ-5D scores
eq5d_plot <- ggplot(health_data, aes(x = factor(osteoarthritis),
                                    y = eq5d_score,
                                    fill = factor(osteoarthritis))) +
  geom_boxplot(alpha = 0.7) +
  labs(
    title = "EQ-5D Scores by Osteoarthritis Status",
    x = "Osteoarthritis Status",
    y = "EQ-5D Score",
    fill = "OA Status"
  ) +
  scale_x_discrete(labels = c("No OA", "Has OA")) +
  scale_fill_brewer(palette = "Set2") +
  theme_minimal()

print(eq5d_plot)
```

---

## Exercise 7: Export Results

### 7.1 Create Results Directory

Create a directory to store analysis results.

```r
# Create results directory if it doesn't exist
if (!dir.exists("results")) {
  dir.create("results")
}
```

### 7.2 Save Key Results

Save important analysis results to R data files.

```r
# Create results summary list
results_summary <- list(
  overall_prevalence = overall_prevalence,
  age_prevalence = age_prevalence,
  sex_state_prevalence = sex_state_prevalence,
  bmi_analysis = bmi_analysis,
  comorbidities_analysis = comorbidities_analysis,
  activity_analysis = activity_analysis,
  model_summary = summary(oa_model),
  odds_ratios = odds_ratios,
  confusion_matrix = confusion_matrix,
  model_accuracy = accuracy,
  auc_value = auc_value,
  advanced_model_summary = summary(advanced_model),
  cost_analysis = cost_analysis,
  qol_analysis = qol_analysis,
  timestamp = Sys.time()
)

# Save results
saveRDS(results_summary, "results/tutorial_01_results.rds")
```

### 7.3 Save Plots

Save all created plots as image files.

```r
# Save plots
ggsave("results/age_distribution.png", age_plot, width = 8, height = 6)
ggsave("results/bmi_distribution.png", bmi_plot, width = 8, height = 6)
ggsave("results/pain_scores.png", pain_plot, width = 8, height = 6)
ggsave("results/state_prevalence.png", state_plot, width = 8, height = 6)
ggsave("results/prediction_plot.png", prediction_plot, width = 8, height = 6)
ggsave("results/cost_plot.png", cost_plot, width = 8, height = 6)
ggsave("results/eq5d_plot.png", eq5d_plot, width = 8, height = 6)
```

### 7.4 Generate Summary Report

Create a comprehensive summary report of the analysis.

```r
# Generate summary report
summary_report <- sprintf("
TUTORIAL 1: BASIC POPULATION HEALTH MODELING
=============================================

EXECUTION SUMMARY
-----------------
Generated on: %s
Dataset size: %d records
Analysis completed successfully

KEY FINDINGS
------------
1. Overall OA Prevalence: %.1f%%
2. Age-related increase: Strong correlation (OR = %.2f per 10 years)
3. Sex differences: Women have %.1f%% higher prevalence
4. BMI impact: Obese individuals have %.1f%% higher prevalence
5. Model Performance: %.1f%% accuracy on test data

TOP RISK FACTORS (Odds Ratios)
-------------------------------
- Age (per 10 years): %.2f
- High BMI (â‰¥30): %.2f
- Female sex: %.2f
- Comorbidities: %.2f

RECOMMENDATIONS
---------------
1. Target screening programs for individuals aged 65+
2. Promote weight management for obesity prevention
3. Consider sex-specific prevention strategies
4. Focus on comorbidity management in high-risk groups

DATA SOURCES
------------
- Synthetic data mimicking AIHW National Health Survey
- Population: 50,000 Australian adults
- Age range: 18-85 years
- Geographic coverage: All Australian states/territories

NEXT STEPS
----------
- Tutorial 2: Healthcare utilization analysis
- Tutorial 3: Longitudinal disease progression modeling
- Tutorial 4: Geographic health disparities analysis
",
  format(Sys.time(), "%Y-%m-%d %H:%M:%S"),
  nrow(health_data),
  overall_prevalence$prevalence_pct,
  odds_ratios["age"]^10,
  (sex_prevalence$prevalence[sex_prevalence$sex == "Female"] /
   sex_prevalence$prevalence[sex_prevalence$sex == "Male"] - 1) * 100,
  (bmi_analysis$prevalence[bmi_analysis$bmi_category == "Obese"] /
   bmi_analysis$prevalence[bmi_analysis$bmi_category == "Normal"] - 1) * 100,
  accuracy * 100,
  odds_ratios["age"]^10,
  odds_ratios["high_bmiTRUE"],
  odds_ratios["femaleTRUE"],
  odds_ratios["comorbidities"]
)

# Write summary to file
writeLines(summary_report, "results/tutorial_01_summary.txt")
```

---

## Key Takeaways

1. **Prevalence Analysis**: Osteoarthritis affects approximately 15-20% of the adult population, with strong age-related increases.

2. **Risk Factors**: Age, BMI, sex, and comorbidities are significant predictors of osteoarthritis risk.

3. **Statistical Modeling**: Logistic regression provides good predictive performance for identifying high-risk individuals.

4. **Data Visualization**: Effective visualizations help communicate complex health data insights to stakeholders.

5. **Policy Implications**: Understanding population health patterns informs targeted prevention and intervention strategies.

## Next Steps

- **Tutorial 2**: Healthcare utilization analysis - examining healthcare costs and service usage patterns
- **Tutorial 3**: Longitudinal disease progression modeling - tracking health changes over time
- **Tutorial 4**: Geographic health disparities analysis - exploring regional variations in health outcomes

## Additional Resources

- [AUS-OA Package Documentation](https://aus-oa.github.io/)
- [Australian Institute of Health and Welfare](https://www.aihw.gov.au/)
- [R for Health Data Science](https://argoshare.is.ed.ac.uk/healthyr_book/)

---

*This tutorial is part of the AUS-OA educational series demonstrating population health modeling techniques using R.*
